name: Artifact Poisoning NPM

# VULN: Untrusted trigger for build
on:
  pull_request_target:

permissions:
  contents: read
  packages: write  # VULN: Can publish to npm

jobs:
  # Job 1: Build package in untrusted context
  build:
    runs-on: ubuntu-latest
    steps:
      # VULN: Checkout untrusted PR code
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # VULN: Running untrusted build scripts
      - run: npm ci
      - run: npm run build

      # VULN: Upload artifact built from attacker code
      - uses: actions/upload-artifact@v3
        with:
          name: dist-package
          path: dist/

  # Job 2: Publish artifact without validation
  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      packages: write
      id-token: write  # VULN: OIDC token access
    steps:
      # VULN: Download potentially poisoned artifact
      - uses: actions/download-artifact@v3
        with:
          name: dist-package
          path: dist/

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # VULN: Publishing poisoned artifact without integrity check
      - run: npm publish ./dist
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
