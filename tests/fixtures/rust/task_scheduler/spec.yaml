# Task Scheduler - Rust Test Fixture for TheAuditor
# Comprehensive fixture covering ALL Rust extraction tables

name: task_scheduler
language: rust
purpose: Complete test fixture for Rust AST extraction and taint analysis

# ============================================================================
# RUST SCHEMA TABLE COVERAGE
# ============================================================================

schema_coverage:
  # Core symbol tables
  rust_modules: COVERED         # mod declarations in all files
  rust_use_statements: COVERED  # use/pub use statements throughout
  rust_functions: COVERED       # 100+ functions across modules
  rust_structs: COVERED         # Job, UserInput, RawBuffer, etc.
  rust_enums: COVERED           # JobState, Priority, Schedule, etc.
  rust_traits: COVERED          # JobHandler, Storage, AsyncStream, etc.
  rust_impl_blocks: COVERED     # Multiple impl blocks per type

  # Generics and lifetimes
  rust_generics: COVERED        # Scheduler<S>, Page<T>, ClosureHandler<F>
  rust_lifetimes: COVERED       # JobFilter<'a>, FFI lifetimes

  # Macros
  rust_macros: COVERED          # macro_rules! job, jobs
  rust_macro_invocations: COVERED # derive, serde attributes
  rust_attributes: COVERED      # #[derive], #[serde], #[cfg], #[repr]

  # Async
  rust_async_functions: COVERED # async_runtime.rs - async_compute, async_sleep, etc.
  rust_await_points: COVERED    # Multiple .await calls in async_runtime.rs

  # Unsafe
  rust_unsafe_blocks: COVERED   # ffi.rs - malloc/free, pointer ops
  rust_unsafe_traits: COVERED   # ffi.rs - FfiSafe, Zeroable, FfiPrimitive

  # Struct/Enum details
  rust_struct_fields: COVERED   # All struct field definitions
  rust_enum_variants: COVERED   # JobState variants with data, CancelReason
  rust_trait_methods: COVERED   # Trait method signatures

  # FFI
  rust_extern_functions: COVERED # ffi.rs - getenv, malloc, memcpy
  rust_extern_blocks: COVERED    # ffi.rs - extern "C" and extern "system"

# ============================================================================
# GRAPH/TAINT TABLE COVERAGE
# ============================================================================

graph_coverage:
  symbols: COVERED          # All types extracted to unified symbols
  function_calls: COVERED   # Cross-module calls, method calls
  assignments: COVERED      # Variable assignments, field assignments
  returns: COVERED          # Return statements
  imports: COVERED          # Use statements -> refs
  cfg: COVERED              # Conditional compilation blocks

# ============================================================================
# TAINT ANALYSIS COVERAGE
# ============================================================================

taint_patterns:
  # Sources (where tainted data enters)
  sources:
    - "read_user_input()"      # stdin
    - "prompt_user()"          # stdin with prompt
    - "read_env_var()"         # environment variables
    - "read_file()"            # file contents
    - "read_file_lines()"      # file lines
    - "read_cli_args()"        # command line arguments
    - "UserInput::from_prompts()" # struct with tainted fields
    - "UserInput::from_env()"     # struct from env vars

  # Sinks (dangerous operations)
  sinks:
    - "execute_command()"      # Command injection
    - "execute_with_args()"    # Command injection
    - "write_file()"           # Path traversal
    - "delete_file()"          # Path traversal
    - "execute_sql()"          # SQL injection
    - "log_message()"          # Log injection
    - "render_html()"          # XSS

  # Sanitizers (functions that clean data)
  sanitizers:
    - "sanitize_shell_input()" # Remove shell metacharacters
    - "sanitize_path()"        # Prevent path traversal
    - "escape_sql()"           # SQL escaping
    - "escape_html()"          # HTML entity escaping
    - "validate_whitelist()"   # Whitelist validation

  # Flow patterns
  flows:
    direct: true          # Source directly to sink
    multi_hop: true       # Through multiple functions
    closure_capture: true # Tainted data in closures
    field_access: true    # Through struct fields
    collection: true      # Through Vec/HashMap
    conditional: true     # Depends on runtime condition

# ============================================================================
# FILE STRUCTURE
# ============================================================================

files:
  # Core library
  src/lib.rs: |
    Library root with:
    - macro_rules! definitions
    - Re-exports (pub use)
    - Error enum with thiserror
    - Constants
    - Static mut with unsafe access

  src/main.rs: |
    CLI entry point with:
    - clap derive macros
    - Subcommands enum
    - Pattern matching

  # Job module
  src/job/mod.rs: |
    Job struct with:
    - Builder pattern (JobBuilder)
    - Multiple impl blocks (4 separate)
    - Newtype pattern (JobId)
    - IntoIterator impl (Tags)
    - PartialEq, Eq, Hash impls
    - Lifetime parameters (JobFilter<'a>)

  src/job/state.rs: |
    State machine with:
    - Complex enum variants with named fields
    - State transitions
    - Display impl

  src/job/handler.rs: |
    Handler system with:
    - Trait with associated types
    - Type aliases (BoxedHandler, SharedHandler)
    - Trait objects (dyn JobHandler)
    - Generic structs (ClosureHandler<F>)

  # Scheduler module
  src/scheduler/mod.rs: |
    Scheduler with:
    - Generic type parameter with where clause
    - Builder pattern with type state
    - Display impl

  src/scheduler/cron.rs: |
    Cron parser with:
    - FromStr impl
    - BTreeSet usage
    - Complex parsing logic

  src/scheduler/executor.rs: |
    Executor with:
    - Atomics (AtomicBool, AtomicUsize)
    - RwLock/Mutex
    - Trait for hooks
    - Builder with type parameters

  # Storage module
  src/storage/mod.rs: |
    Storage trait with:
    - Default method implementations
    - Wrapper types (CachedStorage, LoggingStorage)
    - Clone derive

  src/storage/json.rs: |
    JSON storage with:
    - File I/O
    - Serde integration

  # FFI module (NEW)
  src/ffi.rs: |
    FFI and unsafe with:
    - extern "C" block
    - extern "system" block (Windows)
    - unsafe traits (FfiSafe, Zeroable)
    - unsafe impl
    - unsafe blocks with SAFETY comments
    - Raw pointers
    - Union types
    - static mut
    - !Send/!Sync markers

  # Async module (NEW)
  src/async_runtime.rs: |
    Async patterns with:
    - async fn definitions
    - .await expressions
    - Future trait implementations
    - Pin<&mut Self>
    - Poll enum usage
    - async blocks
    - Custom stream trait
    - Channel implementation

  # Taint module (NEW)
  src/taint_flows.rs: |
    Taint analysis patterns with:
    - Source functions (stdin, env, files)
    - Sink functions (command exec, file write, SQL)
    - Sanitizer functions
    - Direct flows
    - Multi-hop flows
    - Closure capture flows
    - Conditional flows
    - Loop flows
    - Collection propagation

  # Utils
  src/utils.rs: |
    Utilities with:
    - Extension traits (OptionExt, ResultExt)
    - Helper functions
    - Timer struct

# ============================================================================
# BUILD & TEST
# ============================================================================

build:
  command: cargo build
  expected: success (may have warnings for intentional unsafe)

test:
  command: cargo test
  expected: All tests pass

run:
  command: cargo run -- --help
  expected: Shows CLI help with all subcommands
