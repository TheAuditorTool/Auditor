# SAFE: Properly secured GitHub Actions workflow (control for testing)
# This workflow demonstrates security best practices
name: Safe Workflow

on:
  pull_request:  # SAFE: Uses pull_request, not pull_request_target
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read  # SAFE: Minimal permissions

jobs:
  # SAFE: Proper PR validation before any risky operations
  validate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout base branch
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608  # SAFE: SHA pinned

      - name: Validate PR metadata
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # SAFE: Variables in env, not direct interpolation
          echo "Validating PR: $PR_TITLE"

  # SAFE: Build in isolated context without secrets
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Setup Node
        uses: actions/setup-node@5e21ff4d9bc1a8cf6de233a3057d20ec6b3fb69d  # SAFE: SHA pinned
        with:
          node-version: '20'

      - name: Install and build
        run: |
          npm ci  # SAFE: Uses package-lock.json
          npm run build

      - name: Upload artifact with validation
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32  # SAFE: SHA pinned
        with:
          name: build-${{ github.sha }}  # SAFE: Unique name per commit
          path: dist/
          retention-days: 1

  # SAFE: Deploy only from trusted context with proper validation
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # SAFE: Only in trusted push context
    environment: production
    steps:
      - name: Download artifact
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a  # SAFE: SHA pinned
        with:
          name: build-${{ github.sha }}  # SAFE: Exact artifact name

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355  # SAFE: SHA pinned
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Deploy to S3
        run: |
          aws s3 sync . s3://production-bucket/ --delete

  # SAFE: Reusable workflow with limited secrets
  call-internal-workflow:
    uses: ./.github/workflows/internal-deploy.yml@8ade135a41bc03ea155e62e844d188df1ea18608  # SAFE: SHA pinned
    secrets:
      DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}  # SAFE: Explicit secret, not inherit
