# VULN: Untrusted PR code execution with target repo secrets
# Attack: Submit PR with malicious code, workflow runs it with GITHUB_TOKEN write access
name: Vulnerable PR Target

on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  # VULN: Checks out untrusted PR code BEFORE any validation
  vulnerable-build:
    runs-on: ubuntu-latest
    steps:
      # CRITICAL VULN: This checks out attacker-controlled code
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}  # VULN: Untrusted ref

      # VULN: Attacker code now runs with write permissions
      - name: Run tests
        run: |
          npm install
          npm test  # Attacker can modify package.json/test scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # VULN: Secret exposed to untrusted code

  # This should run FIRST but doesn't due to no 'needs:' dependency
  approval:
    runs-on: ubuntu-latest
    steps:
      - name: Require approval
        run: echo "Manual approval required"
