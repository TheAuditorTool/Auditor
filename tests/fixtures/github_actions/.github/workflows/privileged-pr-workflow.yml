# VULN: Excessive permissions in pull_request_target workflow
# Attack: PR can push commits, create tags, publish packages
name: Privileged PR Workflow

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

# VULN: Write-all permissions with untrusted trigger
permissions: write-all

jobs:
  # VULN: Can modify repo content from untrusted PR
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # VULN: Can push commits
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}  # VULN: Untrusted code

      - name: Auto-merge if tests pass
        run: |
          # VULN: Untrusted code can execute with write permissions
          npm test && gh pr merge --auto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # VULN: Can publish packages from untrusted PR
  publish-preview:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # VULN: Can publish to GitHub Packages
      id-token: write  # VULN: Can mint OIDC tokens
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Publish preview package
        run: |
          # VULN: Attacker controls package.json, can publish malicious version
          npm publish --tag pr-${{ github.event.pull_request.number }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # VULN: Can create releases from PR
  create-preview-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Create tag and release
        run: |
          # VULN: PR can create arbitrary tags/releases
          gh release create "pr-${{ github.event.pull_request.number }}" --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
