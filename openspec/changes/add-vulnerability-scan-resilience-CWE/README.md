# Vulnerability Scanner CWE Enhancement

**Status**: ✅ DEPLOYED (Commit de951e3, 2025-11-01)
**OpenSpec**: `add-vulnerability-scan-resilience-CWE`
**Scope**: Extract full CWE arrays from vulnerability scanners

---

## What This Change Does

**Before**: OSV-Scanner extracts CWE arrays but we only stored first element
**After**: Full CWE arrays + CVE/GHSA IDs stored in details_json for FCE correlation

**Files Modified**:
- `theauditor/vulnerability_scanner.py` (~113 lines)
- `theauditor/indexer/schema.py` (1 line)

---

## Quick Start

### For Future AIs

**READ FIRST**: `HANDOFF.md` - Atomic plan, known bugs, what's left to do

**Then Read**:
1. `proposal.md` - Problem statement + actual implementation results
2. `design.md` - Architecture (how it works)
3. `TESTING.md` - Test documentation (16/25 passing)

### Verify It Works

```bash
# Run scanner
aud full --offline

# Check enhanced metadata
python -c "
import sqlite3
conn = sqlite3.connect('.pf/repo_index.db')
c = conn.cursor()
c.execute('''SELECT rule, json_extract(details_json, '\$.cwe_ids'),
             json_extract(details_json, '\$.cve_id')
             FROM findings_consolidated
             WHERE tool='vulnerability_scanner' LIMIT 3''')
for row in c.fetchall():
    print(row)
"
```

**Expected**: cwe_ids as arrays, CVE IDs extracted

---

## What Works (Verified in Production)

✅ Full CWE array extraction (`cwe_ids: ["CWE-770", "CWE-835"]`)
✅ CVE/GHSA ID extraction from aliases
✅ details_json population (400-650 bytes per finding)
✅ File output (valid JSON with proper arrays)
✅ Backward compatibility (cwe column unchanged)
✅ 16/25 tests passing (14 unit, 2 integration, 9 skipped)

**Evidence**: 4 production pipeline runs (PlantFlow, project_anarchy, TheAuditor, plant)

---

## Known Issues (Discovered Post-Deployment)

### ❌ CRITICAL: Cross-Reference Deduplication Broken

- **Problem**: npm-audit and osv-scanner find same vuln, create 2 separate findings
- **Evidence**: 6 duplicate findings (30% duplication rate) across production runs
- **File**: `theauditor/vulnerability_scanner.py:561-584` (_cross_reference method)
- **Fix Needed**: Match by CVE/GHSA/message similarity, merge findings
- **Recommendation**: Separate OpenSpec ticket

### ❌ MAJOR: npm-audit Missing CWE/CVE Enrichment

- **Problem**: npm-audit findings have empty cwe_ids, null cve_id (0% coverage)
- **Evidence**: 6 npm-audit findings vs 13 osv-scanner findings (osv has 100% coverage)
- **File**: `theauditor/vulnerability_scanner.py:256-286` (npm-audit processing)
- **Fix Needed**: Extract GHSA from advisory URL, enrich with OSV data
- **Recommendation**: Separate OpenSpec ticket

### ⚠️ SUSPICIOUS: TheAuditor Runtime Anomaly

- **Problem**: 0.8s for 874 files vs expected 5-8s (9x faster)
- **Impact**: Unknown (needs investigation)
- **Recommendation**: Add runtime benchmarks

---

## Documentation

### Core Documents (Read In Order)

1. **HANDOFF.md** - Start here for future work
2. **proposal.md** - Why + what changed
3. **design.md** - How it works
4. **tasks.md** - What was done (21/38 tasks)
5. **TESTING.md** - Test documentation

### Archive (Historical Only)

- `archive/CWE_ENHANCEMENT_PROGRESS.md` - Session progress (obsolete)
- `archive/VULNERABILITY_SCANNER_VERIFICATION_REPORT.md` - Full audit (reference)
- `archive/VULN_SCANNER_EXEC_SUMMARY.md` - Architect summary (reference)
- `archive/CROSS_AI_SYNC_REPORT.md` - Multi-AI sync (obsolete)

---

## File Structure

```
openspec/changes/add-vulnerability-scan-resilience-CWE/
├── README.md (THIS FILE - quick reference)
├── HANDOFF.md (atomic plan for future work)
├── proposal.md (WHY + actual implementation)
├── design.md (HOW - architecture)
├── tasks.md (STEPS - 21/38 complete)
├── verification.md (PROOF - hypotheses)
├── TESTING.md (test documentation)
└── archive/ (historical/obsolete docs)
```

---

## Source Code Map

### Production Code

```
theauditor/vulnerability_scanner.py
├── Line 434: Extract full CWE array
├── Lines 441-442: Extract CVE/GHSA from aliases
├── Lines 625-635: Build details_json (8 fields)
├── Line 658: Database INSERT with details_json
└── Lines 561-584: _cross_reference (BROKEN - needs fix)

theauditor/indexer/schema.py
└── Line 80: Schema contract (table count)
```

### Tests

```
tests/test_vulnerability_scanner.py (14 unit tests - ALL PASSING)
tests/test_vulnerability_integration.py (11 integration - 2 passing, 9 skipped)
tests/fixtures/vulnerabilities/ (7 test fixtures)
```

---

## Next Steps

### Immediate (Recommended Tickets)

1. **Fix cross-reference deduplication** (CRITICAL)
2. **Enrich npm-audit findings with CWE/CVE** (MAJOR)
3. **Add deduplication tests** (HIGH)

### Future (Backlog)

4. Implement vulnerability chunking (.pf/readthis/)
5. Dynamic confidence scoring
6. Runtime benchmarking

**See HANDOFF.md for detailed plan**

---

## Summary

**What I Delivered**: Full CWE arrays, CVE extraction, details_json (100% of scope)
**What I Discovered**: 2 critical bugs (pre-existing, now visible)
**Quality**: 7/10 (core works, but deduplication broken)
**Status**: Deployed, follow-up work queued

**Last Updated**: 2025-11-01
**Maintainer**: Vulnerability Scanner AI team
