# Python vs JavaScript/TypeScript Parity Audit — Verified Evidence  
**Date:** 2025-10-28  
**Agent:** Codex (Lead Coder) on branch `pythonparity`  

All findings below are anchored in source code and the 2025-10-28 `.pf` artifacts generated by `aud full --offline`. No assumptions or secondary references were used.

---

## Executive Summary

- Python extraction now records **4 321** rows in `type_annotations`, alongside **97** TypeScript/JavaScript rows, closing the previous “0 Python types” gap (`.pf/pipeline.log:21`, SQL query below).
- New framework tables are populated end-to-end: `python_orm_models` (10), `python_orm_fields` (28), `python_routes` (13), `python_blueprints` (2), `python_validators` (7), and `orm_relationships` (16) with bidirectional entries derived from SQLAlchemy/Django extraction.
- `resolved_imports` produces **365** references to Python modules, allowing parity with the JavaScript import map.
- Taint propagation now consumes Python ORM metadata; running `enhance_python_fk_taint` over `.pf/repo_index.db` expands bindings such as `user → posts → tags` and `organization.users`, proving runtime integration.
- Remaining architectural gap: Python still relies on the built-in `ast` module (syntactic only) while TypeScript uses semantic compiler APIs; no type inference engine is present.

---

## Evidence by Capability

### 1. Type Annotation Extraction

- Implementation: `theauditor/ast_extractors/python_impl.py:273-360` serialises parameter/return annotations (including legacy type comments) via `_get_type_annotation`, `_analyze_annotation_flags`, and `_parse_function_type_comment`.
- Storage path: `theauditor/indexer/extractors/python.py:100-139` appends annotation records; `theauditor/indexer/database.py:472-520` persists them into `type_annotations`.
- Verification query:

  ```bash
  .venv/Scripts/python.exe -c "
  import sqlite3
  conn = sqlite3.connect('.pf/repo_index.db')
  print(conn.execute(\"SELECT COUNT(*) FROM type_annotations WHERE file LIKE '%.py'\").fetchone())
  "
  ```

  Output: `(4321,)`

- Sample rows confirming return annotations:

  ```bash
  .venv/Scripts/python.exe -c "
  import sqlite3
  conn = sqlite3.connect('.pf/repo_index.db')
  cur = conn.cursor()
  cur.execute(\"SELECT file, symbol_name, return_type FROM type_annotations WHERE file LIKE 'tests/fixtures/python/%' AND return_type IS NOT NULL LIMIT 5\")
  print(cur.fetchall())
  "
  ```

  Output (abbrev.):  
  `('tests/fixtures/python/import_resolution/app.py', 'bootstrap', 'UserService')`, etc.

### 2. Framework Tables & Relationships

- Extraction logic:
  - SQLAlchemy & Django: `theauditor/ast_extractors/python_impl.py:490-761`
  - Pydantic validators: `python_impl.py:763-812`
  - Flask blueprints / FastAPI dependencies: `python_impl.py:814-843` and `theauditor/indexer/extractors/python.py:220-336`
- Schema & writers: `theauditor/indexer/schema.py:430-520`, `theauditor/indexer/database.py:520-565`
- Verified counts:

  ```bash
  .venv/Scripts/python.exe -c "
  import sqlite3, json
  conn = sqlite3.connect('.pf/repo_index.db')
  cur = conn.cursor()
  tables = {
      'python_orm_models': 'SELECT COUNT(*) FROM python_orm_models',
      'python_orm_fields': 'SELECT COUNT(*) FROM python_orm_fields',
      'orm_relationships': 'SELECT COUNT(*) FROM orm_relationships',
      'python_routes': 'SELECT COUNT(*) FROM python_routes',
      'python_blueprints': 'SELECT COUNT(*) FROM python_blueprints',
      'python_validators': 'SELECT COUNT(*) FROM python_validators'
  }
  print(json.dumps({k: cur.execute(v).fetchone()[0] for k, v in tables.items()}, indent=2))
  "
  ```

  Output:

  ```json
  {
    "python_orm_models": 10,
    "python_orm_fields": 28,
    "orm_relationships": 16,
    "python_routes": 13,
    "python_blueprints": 2,
    "python_validators": 7
  }
  ```

- Relationship sample (cascade + inverse rows):

  ```bash
  .venv/Scripts/python.exe -c "
  import sqlite3
  conn = sqlite3.connect('.pf/repo_index.db')
  cur = conn.cursor()
  cur.execute(\"SELECT source_model, target_model, relationship_type, cascade_delete FROM orm_relationships WHERE source_model IN ('User','Organization','Post','Tag') ORDER BY source_model, as_name LIMIT 12\")
  for row in cur.fetchall():
      print(row)
  "
  ```

### 3. Import Resolution & References

- Resolver: `theauditor/indexer/extractors/python.py:287-371`
- Count check:

  ```bash
  .venv/Scripts/python.exe -c "
  import sqlite3
  conn = sqlite3.connect('.pf/repo_index.db')
  print(conn.execute(\"SELECT COUNT(*) FROM refs WHERE value LIKE '%.py'\").fetchone())
  "
  ```

  Output: `(365,)`

- Example resolved imports: tests confirm entries for `services.user`, `util.helpers`, etc. via `tests/test_python_framework_extraction.py:114-123`.

### 4. Taint Propagation Integration

- Cache preload: `theauditor/taint/memory_cache.py:438-618`
- ORM-aware expansion: `theauditor/taint/orm_utils.py:16-353`
- Runtime proof:

  ```bash
  .venv/Scripts/python.exe - <<'PY'
  import sqlite3
  from theauditor.taint.memory_cache import attempt_cache_preload
  from theauditor.taint.orm_utils import enhance_python_fk_taint

  conn = sqlite3.connect('.pf/repo_index.db')
  cur = conn.cursor()
  cache = attempt_cache_preload(cur, memory_limit_mb=256)
  ctx = {
      'ProfileService.update_profile': {
          'vars': {'user'},
          'displays': {'ProfileService.update_profile'},
          'file': 'tests/fixtures/python/parity_sample.py',
          'python_model_bindings': {'user': 'User'}
      }
  }
  enhance_python_fk_taint(cur, cache, ctx)
  print(sorted(ctx['ProfileService.update_profile']['vars']))
  print(sorted(ctx['ProfileService.update_profile']['python_model_bindings'].items()))
  conn.close()
  PY
  ```

  Output (abridged):

  ```
  ['author', 'author.profile', 'comments', 'organization', 'organization.users', 'post', 'post.tags', 'posts.owner', 'profile.user', 'tags.posts', 'user.posts', ...]
  [('author', 'User'), ('organization', 'Organization'), ('post', 'Post'), ('tags', 'Tag'), ('user', 'User'), ...]
  ```

  This demonstrates multi-hop alias expansion sourced from `python_relationship_aliases` and `python_fk_fields`.

### 5. Pipeline Snapshot

- `.pf/pipeline.log:21` (2025-10-28 run):

  ```
  [Indexer] Indexed 390 files, 31917 symbols, 1697 imports, 17 routes, 2 React components, type annotations: 97 TypeScript, 4321 Python
  ```

---

## Remaining Gaps

1. **Semantic typing still absent for Python.** The extractor relies on CPython `ast` (see `theauditor/ast_extractors/python_impl.py:19-48`); there is no integration with Mypy/Pyright or scope/type inference comparable to the TypeScript compiler pipeline.
2. **Performance benchmarks outstanding.** Tasks.md §4.10 requires before/after timings; no measurements captured yet.
3. **Framework coverage breadth.** Current fixtures cover SQLAlchemy, Flask, FastAPI, and basic Django patterns. Additional Django many-to-many and FastAPI edge cases remain TODO per `tasks.md`.
4. **Logging detail.** Annotation warning logging (`python_impl.py` helpers) still omits file paths; follow-up needed.

---

## SQL / Commands Executed

1. `SELECT COUNT(*) FROM type_annotations WHERE file LIKE '%.py'` → 4321  
2. `SELECT COUNT(*) FROM type_annotations WHERE file LIKE '%.ts' OR file LIKE '%.tsx' OR file LIKE '%.js' OR file LIKE '%.jsx'` → 97  
3. `SELECT COUNT(*) FROM python_orm_models` → 10  
4. `SELECT COUNT(*) FROM python_orm_fields` → 28  
5. `SELECT COUNT(*) FROM orm_relationships` → 16  
6. `SELECT COUNT(*) FROM python_routes` → 13  
7. `SELECT COUNT(*) FROM python_blueprints` → 2  
8. `SELECT COUNT(*) FROM python_validators` → 7  
9. `SELECT COUNT(*) FROM refs WHERE value LIKE '%.py'` → 365  
10. `SELECT file, symbol_name, return_type FROM type_annotations WHERE file LIKE 'tests/fixtures/python/%' AND return_type IS NOT NULL LIMIT 5` (sample rows recorded above)  
11. `SELECT source_model, target_model, relationship_type, cascade_delete FROM orm_relationships WHERE source_model IN ('User','Organization','Post','Tag') ORDER BY source_model, as_name LIMIT 12`

All commands were executed with `.venv/Scripts/python.exe` per `CLAUDE.md` guidelines.
