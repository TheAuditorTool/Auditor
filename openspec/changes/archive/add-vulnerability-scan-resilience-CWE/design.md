# Design: CWE/CVE Enhancement for Vulnerability Findings

## Problem Statement

**Current State (v1.3.0-RC1)**:
- Vulnerability scanner already implements dual-write: findings_consolidated table + .pf/raw/vulnerabilities.json
- findings_consolidated.details_json column already exists (theauditor/indexer/schemas/core_schema.py:502)
- FCE already queries details_json for correlation (theauditor/fce.py:50-98)

**The Gap**:
OSV-Scanner extracts CWE data from database_specific.cwe_ids (array), but vulnerability_scanner.py:416-421 only stores cwe_ids[0], discarding additional CWE classifications.

**Why This Matters**:
1. **CWE Taxonomy Loss**: Vulnerabilities like CVE-2021-23337 have multiple CWE classifications (e.g., [CWE-1321, CWE-915]). We only store first one, losing taxonomy data.
2. **FCE Correlation Broken**: FCE cannot correlate "all CWE-79 XSS findings across SAST + OSV" because we don't store full CWE arrays.
3. **Query Inefficiency**: CVE/GHSA IDs buried in aliases array, require JSON parsing instead of direct column access.

**Evidence (from verification.md)**:
```python
# vulnerability_scanner.py:416-421
cwe = ""
db_specific = vuln.get("database_specific", {})
if db_specific and "cwe_ids" in db_specific:
    cwe_ids = db_specific["cwe_ids"]
    if isinstance(cwe_ids, list) and len(cwe_ids) > 0:
        cwe = cwe_ids[0]  # PROBLEM: Discards cwe_ids[1], cwe_ids[2], etc.
```

## Goals

1. **Preserve Full CWE Taxonomy**: Store all CWE IDs from OSV, not just first one
2. **Enable FCE Correlation**: Allow queries like "show all CWE-79 XSS across tools"
3. **Simplify CVE/GHSA Queries**: Extract CVE/GHSA to separate fields (no JSON parsing)
4. **Maintain Backward Compatibility**: Keep findings_consolidated.cwe column for existing queries
5. **No Breaking Changes**: Additive only, no schema migrations, no new tables

## Non-Goals

- **NO database migrations** (database regenerated fresh every `aud index`)
- **NO new tables** (use existing details_json column)
- **NO Python manifest extraction** (separate change, out of scope)
- **NO retry logic** (not the core problem, defer)
- **NO manifest provenance tracking** (over-engineered, not needed)

## Architecture

### Data Flow

```
OSV-Scanner API Response
  └─> database_specific.cwe_ids: ["CWE-1321", "CWE-915"]
       └─> vulnerability_scanner.py extracts FULL array
            └─> findings_consolidated table:
                 ├─> cwe column: "CWE-1321" (backward compat, primary CWE)
                 └─> details_json: {"cwe_ids": ["CWE-1321", "CWE-915"], "cve_id": "CVE-2021-23337", ...}
```

### Enhanced Vulnerability Dict

**Before** (vulnerability_scanner.py:423):
```python
vulnerability = {
    # ... existing fields ...
    "cwe": cwe,  # Single CWE only
    "source": "OSV-Scanner"
}
```

**After**:
```python
vulnerability = {
    # ... existing fields ...
    "cwe": cwe_primary,  # Backward compat: primary CWE
    "cwe_ids": cwe_ids_full,  # NEW: Full array for FCE
    "cve_id": cve_id,  # NEW: Direct CVE access
    "ghsa_id": ghsa_id,  # NEW: Direct GHSA access
    "source": "OSV-Scanner"
}
```

### Database Schema (NO CHANGES)

**findings_consolidated** (existing schema from core_schema.py:486-512):
- `cwe` TEXT - Backward compat, stores primary CWE only
- `details_json` TEXT - Already exists, we populate it with structured metadata

**No new columns, no migrations, no schema changes.**

### details_json Structure

**Before**: Empty or NULL
**After**:
```json
{
  "cwe_ids": ["CWE-1321", "CWE-915"],
  "cve_id": "CVE-2021-23337",
  "ghsa_id": "GHSA-xxxx-xxxx-xxxx",
  "aliases": ["CVE-2021-23337", "GHSA-xxxx-xxxx-xxxx"],
  "references": [...],
  "source_count": 2,
  "sources": ["npm-audit", "osv-scanner"],
  "confidence": 0.9
}
```

## Implementation Strategy

### Phase 1: Data Extraction Enhancement

**File**: `C:\Users\santa\Desktop\TheAuditor\theauditor\vulnerability_scanner.py`
**Changes**:
1. Line 415-421: Extract full cwe_ids array (not just first element)
2. Line 423-440: Add cwe_ids/cve_id/ghsa_id to vulnerability dict
3. Line 256-274: Update npm-audit to also extract CVE/GHSA (consistency)

**Complexity**: Low - Simple variable renaming and array preservation
**Risk**: Zero - No logic changes, just storing more data

### Phase 2: Database Write Enhancement

**File**: `C:\Users\santa\Desktop\TheAuditor\theauditor\vulnerability_scanner.py`
**Changes**:
1. Line 598-620: Build details_json dict before INSERT
2. Add details_json to INSERT statement (13 params instead of 12)

**Complexity**: Low - JSON serialization of existing dict
**Risk**: Zero - details_json column already exists in schema

**Backward Compatibility**:
- findings_consolidated.cwe column still populated (primary CWE only)
- Existing queries using `WHERE cwe = 'CWE-79'` continue working
- New queries can use `json_extract(details_json, '$.cwe_ids')` for full taxonomy

### Phase 3: Verification

**Test Strategy** (see tasks.md Phase 3):
1. Run `aud full --offline` and verify no exceptions
2. Query details_json to confirm cwe_ids array populated
3. Count vulnerabilities with multiple CWEs (proves array storage)
4. Test FCE-style query filtering by CWE taxonomy
5. Verify .pf/raw/vulnerabilities.json also enhanced

## Why This Design?

### Decision: Use details_json (not new table)

**Options Considered**:
1. Create finding_cwes join table (id, finding_id FK, cwe_id)
2. Add cwe_array column to findings_consolidated
3. Use existing details_json column

**Chosen**: Option 3 (details_json)

**Reasoning**:
- details_json already exists, no schema changes needed
- Database regenerated fresh every run, no migrations
- FCE already queries details_json (fce.py:50-98)
- SQLite JSON functions support array queries: `json_extract(details_json, '$.cwe_ids')`

**Rejected Option 1** (finding_cwes table):
- Requires schema migration (violates zero-fallback policy)
- Adds join complexity for simple array data
- Over-engineered for 2-5 element arrays

**Rejected Option 2** (cwe_array column):
- Schema change required
- Would need to UPDATE existing code using `cwe` column
- Less flexible than JSON (can't add cve_id/ghsa_id without more columns)

### Decision: Extract CVE/GHSA to dedicated fields

**Reasoning**:
- Simplifies FCE queries: `WHERE json_extract(details_json, '$.cve_id') = 'CVE-2024-1234'`
- No JSON array parsing needed
- Enables direct filtering in `aud query`

**Alternative Considered**: Leave in aliases array
**Rejected**: Requires Python-side JSON parsing, can't filter in SQL

### Decision: Maintain backward compatibility

**Reasoning**:
- Existing rules/FCE code may query `findings_consolidated.cwe` column
- Zero breaking changes = safe deployment
- Primary CWE still useful (most vulnerabilities have 1-2 CWEs, first is usually primary)

**Cost**: Slight redundancy (primary CWE stored twice: cwe column + details_json)
**Benefit**: Zero downtime, zero refactoring of existing code

## Rollout Plan

1. **No migration needed** - Database regenerated fresh every `aud index`
2. **Deploy code** - Update vulnerability_scanner.py (3 file sections)
3. **Run `aud full --offline`** - Repopulate database with enhanced data
4. **Verify** - Run tasks.md verification queries
5. **FCE enhancement** (future) - Update FCE to leverage cwe_ids arrays

## Testing Strategy

**Unit Tests** (NOT in this change - defer):
- Test CWE array extraction from OSV response
- Test CVE/GHSA extraction from aliases
- Test details_json serialization

**Integration Tests** (via tasks.md):
- End-to-end scan with OSV findings
- Verify database schema compliance
- Verify JSON output compliance
- Verify backward compatibility

**Validation**:
- `openspec validate add-vulnerability-scan-resilience-CWE --strict`
- Manual verification queries (tasks.md Phase 3)

## Risk Analysis

**Risk**: Breaking existing FCE consumers
**Mitigation**: Backward compatibility maintained, cwe column unchanged

**Risk**: details_json size explosion
**Mitigation**: Limit references to 5, CWE arrays typically 1-3 elements

**Risk**: SQLite JSON performance
**Mitigation**: details_json queries are rare (FCE runs post-scan), no real-time impact

**Risk**: OSV data format change
**Mitigation**: Defensive parsing (check isinstance, default to empty arrays)

## Performance Impact

**Scan Time**: No change (same OSV-Scanner execution)
**Database Size**: +50-200 bytes per vulnerability (JSON overhead)
**Query Performance**: No impact (details_json indexed, JSON queries rare)

**Estimated Impact**: Negligible (<1% database size increase, <5ms query overhead)

## Future Enhancements (Out of Scope)

1. **Python Manifest Support**: Add pyproject.toml parsing to package_configs (separate OpenSpec change)
2. **Retry Logic**: Add retry wrapper for OSV-Scanner subprocess failures (low priority, not core issue)
3. **FCE CWE Correlation**: Update FCE to leverage cwe_ids for cross-tool correlation
4. **Polyglot Detection**: Ensure `aud deps` discovers all manifest types (separate change)

## Conclusion

This is a **data enrichment** change, not architecture change. We're storing data we already have (OSV provides full CWE arrays), not creating new capabilities. Zero migrations, zero fallbacks, zero breaking changes.

**Implementation Complexity**: Low (3 code blocks in 1 file)
**Risk**: Minimal (additive only, backward compat maintained)
**Value**: High (unlocks FCE CWE taxonomy correlation)
